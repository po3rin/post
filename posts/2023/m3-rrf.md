---
title: Reciprocal Rank Fusion(RRF)でtext-embedding-ada-002を使ったベクトル検索とBM25のランキングを統合する
cover: img/gopher.png
date: 2023/03/05
id: m3-cruft
description: Go is a programming language
tags:
    - golang
    - markdown
draft: true
---

エムスリーエンジニアリンググループ AI・機械学習チームでソフトウェアエンジニアをしている中村([po3rin](https://twitter.com/po3rin)) です。検索とGoが好きです。

今回はElasticsearch8.8で利用可能になったReciprocal Rank Fusion (RRF)をElastic Cloudで利用してみたので、RRFのロジックの説明と、触ってみた初感をお伝します。

## RRFとは

Reciprocal Rank Fusion (RRF) は複数のIRシステムから得たドキュメントのランキングを結合する手法です。

例えば、BM25とベクトル検索などの複数のランキング手法を組み合わせることを考えます。愚直にやるならBM25のスコアとベクトル検索のスコアを線形結合して、そのスコアでリランキングすることが考えられます。その際には各検索結果の重みはこちらで決めるがあります。このパラメータを決定する過程では、過去の検索結果を眺めながら、ドメイン知識と検索の知識の両方を合わせて最適なパラメータを決定する必要があるため、難しい作業です。そこでRRFの登場です。

RRFは単純なスコア計算式に従って文書を並べ替えます。ランク付けされるドキュメントのセットDとランク付けのセットR (それぞれ 1..|D| の順列) が与えられると、次のように計算します。

$$
RRF_{score}(R\in D) = \sum_{r\in R} \dfrac{1}{k + r(d)}
$$

かなりシンプルです。RRFのポイントとして元々のスコアの値を利用しない点が挙げられます。IRシステムごとにスコアのレンジが変わるので、スコアの値を利用するリランキングは基本的にスコアを正規化する必要があります。しかし、RRFはスコアの値を使わないので、スコア正規化フェーズをスキップできます。つまり、最終的なスコアは単純に各検索結果の順位だけに依存します。

定数kは、外れ値による上位ランキングの影響を軽減するための定数です。教師あり学習からランク付けする手法が人気な一方で、RRFは学習データセットを必要としないためすぐに導入することができます。論文での実験ではk = 60が最適な値である一方で、kの選択は重要ではないと
う結果を与えています。下記のテーブルは論文からの引用で、kの値を変えた時の検索評価指標MAPの値です(下のテーブルは競合手法のMAP)。

<img src=./map-by-k.png>

LINEさんの導入令ではkを動的な値として、IRシステムごとにkの値を変更しているようです。
https://engineering.linecorp.com/ja/blog/a-new-challenge-for-line-timeline-3

例えばBM25の検索結果が

```
D1, D2, D3, D4, D5
```

ベクトル検索の検索結果が

```
D3, D1, D5, D4, D2
```

の場合、RRFはそれぞれ下記になります。

```
D1: 1/(k + 1) + 1/(k + 2)
D2: 1/(k + 2) + 1/(k + 5) 
D3: 1/(k + 3) + 1/(k + 1) 
D4: 1/(k + 4) + 1/(k + 4) 
D5: 1/(k + 5) + 1/(k + 3)
```

k=60の場合の最終的な順位は

```
D1, D3, D2, D5, D4
```

となります。

## Elastic CloudでのRRF

RRFは上田さんのブログによるとElastic Cloudのプラチナプランであれば利用できるようです。エムスリーではElastic Cloudのプラチナプランを契約しているので、すぐに利用できます。

https://shunyaueta.com/posts/2023-06-02-2323/#fn:3

今回はBM25による検索とベクトル検索の結果をRRFで結合してみます。データセットは弊社がが運用する医師への質問サービスAskDoctorsの質問データを利用します。

ベクトル化はSentence-BERTを使います。過去に同じ方法でベクトル化して検索を試みた記事があるので、ベクトル化の詳細はこちらをご覧ください。
https://www.m3tech.blog/entry/vald-sentence-bert

ベクトル化したドキュメントを下記設定のIndexに投入します。

## ELSEとBM25はRFFで統合できない？

